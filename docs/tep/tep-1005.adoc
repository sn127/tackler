= TEP-1005: TXN Filter

Transaction filters are used to filter txn stream based on transaction's attributes.

Transaction filters can be used to define which transactions will be fed to the accounting engine.
If transaction is filtered out, it will be disappear from transaction stream and vanish from
engine's perspective. So it would not be part of any calculations or reports.

The main usage for this feature is server interface at the moment.


== Journal file format

No journal file changes.

== CLI changes

There will be command line option to feed filter definition to the engine for testing purposes.

* [ ] `--api-filter-def` Filter definition as json


== CONF changes

No configuration settings for filters.


== Machinery

There will be changes to the machine.

* [ ] Translate filter definition to actual filter
* [ ] Apply filter to the txn-stream


=== API changes

Server and client API will be changed to support filters.


==== Server API changes

Changes to server API. Items in italics will be implemented later.

* [x] filter json def
* [ ] filters with report's metadata
** [ ] filters with report's metadata (text)
** [ ] filters with report's metadata (json)
* [x] filter-tree
** [x] nodes
*** [x] `AND`
*** [x] `OR`
*** [x] `NOT`
** [x] leaves
*** [x] Transcation header
**** [x] *`timestamp`*, ZonedDateTime
**** [x] *`code`*, String
**** [x] *`description`*, String
**** [x] *`uuid`*, String
**** [x] *`comments`*, String
*** [x] Postings
**** [x] *`account`*, String
**** [x] `amount`, (account, amount: String + BigDecimal)
***** [x] `amount:exact`, BigDecimal
***** [x] `amount:less`, BigDecimal
***** [x] `amount:greater`, BigDecimal
**** [x] *`commodity`*, String
**** [x] *`comment`*, String


==== Client API changes

Changes to client API's JSON model

* [ ] TODO: filter metadata


=== New dependencies

* [ ] link / url of new dependency
** [ ] Add and check licenses: link / url
** [ ] Is there NOTICE file(s)?
** [ ] Add license under link:../licenses[doc/licenses]
*** [ ] Add NOTICES under link:../licenses[doc/licenses]
** [ ] Add link of license to link:../readme.adoc[index]
** [ ] Add link to link:../../THANKS.adoc[THANKS]
** [ ] Add license material to binary distribution


== Reporting

Filter definitions will be available with reports metadata.

=== Balance report

Changes to balance report

* [ ] Include filter def into report's metadata


=== Balance Group report

Changes to balance group report

* [ ] Include filter def into report's metadata


=== Register report

Changes to register report

* [ ] Include filter def into report's metadata


== Exporting

Initial implementation of filters does not support Exports.

=== Equity export

No changes to equity export

=== Identity export

No changes to identity export

== Documentation

* [ ] link:../../CHANGELOG[]: add new item
* [ ] User docs
** [ ] user manual
*** [ ] cli-arguments
**** [ ] `--api-filter-def`
* [ ] Developer docs
** [ ] API changes
*** [ ] Server API changes
*** [ ] Client API changes


== Future plans

* Support filtering with exports.
* Support XOR-filter trees


== Tests

Normal, ok-case tests to validate functionality:

* [ ] filter json def
* [ ] filters with report's metadata
** [ ] filters with report's metadata (text)
** [ ] filters with report's metadata (json)
* [x] filter tree
** [x] logical nodes
*** [x] *`AND`*
*** [x] *`OR`*
*** [x] *`NOT`*
** [x] leaves
*** [x] Transcation header
**** [x] *`timestamp`*, ZonedDateTime
***** [x] *`begin`*, ZonedDateTime
***** [x] *`end`*, ZonedDateTime
**** [x] *`code`*, String
**** [x] *`description`*, String
**** [x] *`uuid`*, String
**** [x] *`comments`*, String
*** [x] Postings
**** [x] *`account`*, String
**** [x] `amount`, (account, amount: String + BigDecimal)
***** [x] `amount:exact`, BigDecimal
***** [x] `amount:less`, BigDecimal
***** [x] `amount:greater`, BigDecimal
**** [x] *`commodity`*, String
**** [x] *`comment`*, String


=== Errors

Tests for error cases:

* [ ] e: Invalid filter definition
* [ ] e: Result set after filtering is empty


=== Perf

Is there need to run or create new perf tests?

* [ ] perf: Performance test with filtering enabled
* [ ] perf: Run all tests with filtering engine (while no active filters)


=== Test coverage tracking

link:../../tests/tests-1005.yml[TEP-1005 test cases]
